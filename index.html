<!DOCTYPE html>
<html>
<head>
    <title>Cyberball - Protocole 33%</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        body { background-color: #f0f2f5; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .game-canvas { position: relative; width: 600px; height: 400px; background: white; border-radius: 20px; border: 2px solid #ddd; margin: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .player { position: absolute; width: 100px; text-align: center; font-size: 14px; font-weight: bold; transition: transform 0.2s; }
        .player img { width: 70px; height: 70px; border-radius: 50%; background: #eee; border: 3px solid #ccc; }
        .cliquable { cursor: pointer; }
        .cliquable:hover { transform: scale(1.1); }
        .cliquable img { border-color: #007aff; box-shadow: 0 0 15px rgba(0,122,255,0.4); }
        #pos-julie { top: 20px; left: 250px; }
        #pos-marc { top: 250px; left: 50px; }
        #pos-vous { top: 250px; right: 50px; }
        #ball-sprite { position: absolute; width: 22px; height: 22px; background: radial-gradient(circle, #ff9500, #ff5e00); border-radius: 50%; transition: all 0.9s cubic-bezier(0.4, 0, 0.2, 1); z-index: 99; top: 80px; left: 290px; }
        .ui-box { margin-top: 20px; height: 40px; text-align: center; color: #666; font-style: italic; }
    </style>
</head>
<body>
    <script>
        // --- PARAMÈTRES SCIENTIFIQUES ---
        const totalPassesExperience = 30; 
        const passesPourMoiMax = 10; // 33% de 30
        const tempsTotalVise = 240000; // 4 minutes en ms
        // Temps moyen par passe (mouvement + réflexion bot) = env 8 secondes
        // -------------------------------

        const jsPsych = initJsPsych({
            on_finish: function() {
                document.body.innerHTML = '<div style="text-align:center; margin-top:100px; font-family:sans-serif;"><h2>Merci de votre participation</h2><p>L\'exercice est terminé.</p></div>';
            }
        });

        let passesEffectuees = 0;
        let mesPassesRecues = 0;

        const game_trial = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="game-canvas">
                    <div id="pos-julie" class="player"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Julie"><br>Julie</div>
                    <div id="pos-marc" class="player"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Marc"><br>Marc</div>
                    <div id="pos-vous" class="player"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=User"><br>Vous</div>
                    <div id="ball-sprite"></div>
                </div>
                <div class="ui-box"><p id="instruction">Initialisation de la session...</p></div>`,
            choices: [],
            on_load: function() {
                const ball = document.getElementById('ball-sprite');
                const julieDiv = document.getElementById('pos-julie');
                const marcDiv = document.getElementById('pos-marc');
                const instr = document.getElementById('instruction');

                const coords = {
                    'julie': { top: '80px', left: '290px' },
                    'marc': { top: '280px', left: '85px' },
                    'vous': { top: '280px', left: '495px' }
                };

                function move(target) {
                    ball.style.top = coords[target].top;
                    ball.style.left = coords[target].left;
                    passesEffectuees++;

                    julieDiv.classList.remove('cliquable');
                    marcDiv.classList.remove('cliquable');
                    julieDiv.onclick = null;
                    marcDiv.onclick = null;

                    if (passesEffectuees >= totalPassesExperience) {
                        setTimeout(() => jsPsych.finishTrial(), 3000);
                        return;
                    }

                    if (target === 'vous') {
                        mesPassesRecues++;
                        instr.innerHTML = "À vous ! Cliquez sur un joueur pour lancer.";
                        setTimeout(() => {
                            julieDiv.classList.add('cliquable');
                            marcDiv.classList.add('cliquable');
                            julieDiv.onclick = () => move('julie');
                            marcDiv.onclick = () => move('marc');
                        }, 500); 
                    } else {
                        instr.innerHTML = "Réflexion des autres joueurs...";
                        
                        // TEMPS DE DÉCISION (Moyennement long : entre 4 et 7 secondes)
                        const delaiReflexion = Math.floor(Math.random() * 3000) + 4000;

                        setTimeout(() => {
                            let next;
                            // Forcer le 33% (10 passes max pour le joueur)
                            if (mesPassesRecues < passesPourMoiMax) {
                                // On tire au sort : 1 chance sur 2 de l'envoyer au joueur
                                const randomChoice = Math.random();
                                if (randomChoice < 0.5) {
                                    next = 'vous';
                                } else {
                                    next = (target === 'julie') ? 'marc' : 'julie';
                                }
                            } else {
                                // Quota de 33% atteint : les bots ne jouent plus qu'entre eux
                                next = (target === 'julie') ? 'marc' : 'julie';
                            }
                            move(next);
                        }, delaiReflexion);
                    }
                }

                setTimeout(() => move('julie'), 2000);
            }
        };

        jsPsych.run([game_trial]);
    </script>
</body>
</html>
