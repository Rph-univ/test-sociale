<!DOCTYPE html>
<html>
<head>
    <title>Etude Psychologique - Cyberball</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .game-canvas { position: relative; width: 600px; height: 400px; background: white; border-radius: 20px; border: 2px solid #ddd; margin: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .player { position: absolute; width: 80px; text-align: center; font-size: 14px; font-weight: bold; }
        .player img { width: 50px; height: 50px; border-radius: 50%; background: #eee; border: 2px solid #007aff; }
        #pos-julie { top: 20px; left: 260px; }
        #pos-marc { top: 280px; left: 50px; }
        #pos-vous { top: 280px; right: 50px; }
        #ball-sprite { position: absolute; width: 20px; height: 20px; background: orange; border-radius: 50%; transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1); z-index: 99; top: 80px; left: 290px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .ui-box { margin-top: 20px; height: 60px; text-align: center; }
        .jspsych-btn { border-radius: 20px !important; padding: 10px 20px !important; background-color: #007aff !important; }
    </style>
</head>
<body>
    <script>
        // Initialisation de l'expérience
        const jsPsych = initJsPsych({
            on_finish: function() {
                // Message de fin propre
                document.body.innerHTML = `
                    <div style="margin: auto; max-width: 500px; text-align: center; padding: 40px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h2 style="color: #007aff;">Merci de votre participation</h2>
                        <p>L'exercice est maintenant terminé. Vos réponses ont été enregistrées.</p>
                        <p>Vous pouvez fermer cet onglet en toute sécurité.</p>
                    </div>`;
                // Les données sont envoyées dans la console (F12)
                console.log(jsPsych.data.get().asJSON());
            }
        });

        // Tirage au sort : Exclusion ou Inclusion
        const isExcluded = Math.random() < 0.5;
        let passes = 0;
        const totalPassesMax = 40; // Le jeu s'arrête après 40 passes

        // Étape 1 : Accueil
        const welcome = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `<h3>Bienvenue dans cet exercice de visualisation mentale</h3>
                       <p>Vous allez jouer à un jeu de passes virtuel avec deux autres participants en ligne (Julie et Marc).<br>
                       Imaginez la scène le plus réellement possible.</p>`,
            choices: ['Commencer la partie']
        };

        // Étape 2 : Le Jeu Cyberball
        const game_trial = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="game-canvas">
                    <div id="pos-julie" class="player"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Julie"><br>Julie</div>
                    <div id="pos-marc" class="player"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Marc"><br>Marc</div>
                    <div id="pos-vous" class="player"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=User"><br>Vous</div>
                    <div id="ball-sprite"></div>
                </div>
                <div class="ui-box">
                    <p id="instruction" style="color: #666;">Connexion aux autres joueurs...</p>
                </div>`,
            choices: ['Julie', 'Marc'],
            button_html: '<button id="btn-%choice%" class="jspsych-btn" style="display:none; margin: 0 10px;">Lancer à %choice%</button>',
            on_load: function() {
                const ball = document.getElementById('ball-sprite');
                const btnJulie = document.getElementById('btn-Julie');
                const btnMarc = document.getElementById('btn-Marc');
                const instr = document.getElementById('instruction');

                const coords = {
                    'julie': { top: '80px', left: '290px' },
                    'marc': { top: '290px', left: '80px' },
                    'vous': { top: '290px', left: '500px' }
                };

                function move(target) {
                    ball.style.top = coords[target].top;
                    ball.style.left = coords[target].left;
                    passes++;

                    // Fin du jeu
                    if (passes >= totalPassesMax) {
                        setTimeout(() => jsPsych.finishTrial(), 2000);
                        return;
                    }

                    if (target === 'vous') {
                        // C'est au tour de l'utilisateur
                        instr.innerHTML = "<strong>À VOUS !</strong> Choisissez à qui lancer la balle.";
                        btnJulie.style.display = 'inline-block';
                        btnMarc.style.display = 'inline-block';
                    } else {
                        // C'est au tour d'un bot
                        instr.innerHTML = "Julie et Marc s'échangent la balle...";
                        btnJulie.style.display = 'none';
                        btnMarc.style.display = 'none';

                        setTimeout(() => {
                            let next;
                            if (isExcluded && passes > 5) { 
                                // Ostracisme : Après 5 passes d'accueil, les bots s'excluent
                                next = (target === 'julie') ? 'marc' : 'julie';
                            } else {
                                // Inclusion : Aléatoire entre les deux autres
                                const options = (target === 'julie') ? ['marc', 'vous'] : ['julie', 'vous'];
                                next = options[Math.floor(Math.random() * options.length)];
                            }
                            move(next);
                        }, 1200);
                    }
                }

                // Liaison des boutons
                btnJulie.onclick = () => move('julie');
                btnMarc.onclick = () => move('marc');

                // Lancement automatique (la balle commence chez Julie)
                setTimeout(() => move('julie'), 1500);
            },
            on_finish: function(data) {
                // Enregistre la condition dans les résultats
                data.condition = isExcluded ? 'Exclusion' : 'Inclusion';
            }
        };

        // Lancement de la séquence
        jsPsych.run([welcome, game_trial]);
    </script>
</body>
</html>
